# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a **Quiz Buzzer System** built as a Turborepo monorepo with pnpm workspaces. It's a real-time multiplayer quiz buzzer game where players compete to buzz in first, similar to game shows like Jeopardy. The system uses Socket.IO for real-time WebSocket communication between a Node.js backend and Next.js frontend.

## Essential Commands

**Development:**
```bash
pnpm install              # Bootstrap all workspace dependencies
pnpm dev                  # Run both API and web in dev mode (parallel)
pnpm --filter api dev     # Run only API server (tsx watch on port 3001)
pnpm --filter web dev     # Run only web app (Next.js on port 3000)
```

**Build & Production:**
```bash
pnpm build                # Build all workspaces
pnpm --filter api build   # Build API only (outputs to dist/)
pnpm --filter web build   # Build web only (outputs to .next/)
pnpm --filter api start   # Run compiled API server
```

**Quality & Formatting:**
```bash
pnpm lint                 # Lint all workspaces
pnpm format               # Format with Prettier
pnpm check-types          # Type-check (currently API only)
pnpm --filter api check-types  # Type-check API specifically
```

## Architecture

### Monorepo Structure
- **Turborepo** orchestrates builds/tasks (see `turbo.json`)
- **pnpm workspaces** manage dependencies
- `apps/api` - Express + Socket.IO backend
- `apps/web` - Next.js 16 App Router frontend
- `packages/` - Reserved for future shared libraries

### API Architecture (`apps/api`)

**Core Services (Singleton Pattern):**
- `room-service.ts` - Room lifecycle: create/join/delete rooms, manage room codes, cleanup
- `game-service.ts` - Game logic: buzzer locking, score updates, host authorization
- `player-service.ts` - Player management: add/remove players, track scores

**Key Design Patterns:**
- Services are **singletons** exported as `export const roomService = new RoomService()`
- State is in-memory (Maps): `rooms`, `roomCodeToId` in RoomService
- Socket handlers in `handlers/socket-handlers.ts` orchestrate service calls
- Types in `types/` define Socket.IO events (`ClientToServerEvents`, `ServerToClientEvents`) and domain models (`Room`, `Player`, `BuzzerState`)

**Real-time Flow:**
1. Client connects via Socket.IO
2. `setupSocketHandlers()` registers event listeners
3. Events like `create_room`, `join_room`, `buzz` trigger service methods
4. Services update in-memory state and return results
5. Socket handlers emit events to rooms/clients via `io.to(roomId).emit()`

**Important Implementation Details:**
- Room codes are **4-character uppercase** alphanumeric (generated by `nanoid`)
- Buzzer locking is **first-come-first-served** with timestamp tracking
- Only **host can reset buzzer** and **update scores** (enforced in `game-service.ts`)
- Empty rooms are cleaned up via `cleanupEmptyRooms()`

### Web Architecture (`apps/web`)

- Next.js 16 with **App Router** (`src/app/`)
- Tailwind CSS v4 for styling
- React 19 with React Compiler enabled
- Client-side Socket.IO connection to API (planned/TBD)

## Development Conventions

**TypeScript:**
- ES modules throughout (`.js` extensions in imports required)
- Strict typing with Zod validation on API boundaries
- Shared types prevent drift between API and web

**Naming:**
- Files: kebab-case (`game-service.ts`, `socket-handlers.ts`)
- Variables/functions: camelCase
- Components: PascalCase
- Room codes: UPPERCASE

**Git Conventions:**
- Conventional Commits: `<type>(<scope>): <summary>`
- Types: `feat`, `fix`, `docs`, `style`, `refactor`, `test`, `chore`
- Scopes: `api`, `web`, `repo` (align to workspaces)
- Example: `feat(api): add player score tracking`

## Testing (Not Yet Implemented)

When adding tests:
- Preferred: **Vitest + supertest** for API, **React Testing Library or Playwright** for web
- Place tests near code: `apps/api/src/services/__tests__/`
- Update package.json `test` scripts and add `test` task to `turbo.json`
- Critical flows to cover: room creation, join validation, buzzer lock ordering, host-only actions

## Environment Configuration

**API defaults:**
- `PORT=3001`
- `CLIENT_URL=http://localhost:3000` (for CORS)

Override via `.env` files in workspace roots (never commit secrets).

## Common Gotchas

- **Always use `.js` extensions** in TypeScript imports (ES module requirement)
- **Room lookup**: Use `getRoomByCode()` for client inputs, `getRoomById()` for socket room IDs
- **Socket rooms vs. game rooms**: Socket.IO "rooms" (for broadcasting) map 1:1 to game Room IDs
- **Singleton services**: Import as `import { roomService } from './services/room-service.js'`, not `new RoomService()`
- **Turbo caching**: Dev tasks are `persistent: true` and don't cache; builds cache to `.next/`, `dist/`
